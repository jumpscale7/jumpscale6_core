#!/usr/bin/env python
from JumpScale import j

j.application.appname = "jumpscale:jsexec"
j.application.start()

from JumpScale.baselib import cmdutils

parser = cmdutils.ArgumentParser()

parser.add_argument('-r', '--remote', help='hostname of node.',default="")
parser.add_argument('-p', '--passwd', help='Root password to use, if any.',default="")

parser.add_argument('-n','--name',required=False, help='Names of jumpscript to execute (comma separated)',default="")
parser.add_argument('-o','--gridname',required=False, help='Name of grid.',default="")

parser.add_argument('-c', '--cfgname', help='Name of cfg directory.',default="")
parser.add_argument('-e', '--extra', help='Extra config data in tag format e.g. cpasswd:123,myname:kds ',default="")
parser.add_argument('-f','--force',required=False, action='store_true',help='auto answer yes on every question and redo even if already done')
parser.add_argument('-x','--command',required=False, help='if this one is used then just this command will be execute',default="")
parser.add_argument('-s','--sync',required=False, action='store_true',help='then will be done one after the other')
parser.add_argument('-g',  action='store_true', required=False, help='Apply on all active nodes on grid')
parser.add_argument('--roles', required=False, help='Used with -g. Apply on active nodes that have these roles. ex: --roles=node, computenode.kvm(note the = sign). List is comma seperated')
parser.add_argument('-t','--timeout', required=False, type=int, default=0, help='Time to wait to if connection is not available')

args = parser.parse_args()
args.action=None
args.local=False

if args.command=="" and args.name=="":
    raise RuntimeError("command or name needs to be given.")

import JumpScale.baselib.redis

from multiprocessing import Process, Queue

class RedirectSTDOUT:
    def __init__(self,name):
        self.oldstdout=sys.stdout        
        self.name=name
        # self.redis.hset("admin:output",self.name,"")
        self.out=""

    def isatty(self):
        return True

    def flush(self):
        pass

    def write(self, text):
        # self.oldstdout.write(text)
        # out=str(self.redis.hget("admin:output",self.name))
        self.out+=str(text)
        # self.redis.hset("admin:output",self.name,out)

import sys

import time

def doRemote(args,hostkey,cmd):
    # j.admin.hosts=[host]

    def report(node,args):
        if args.sync==False:
            node.out+="\nSTDOUT:\n%s"%r.out            
        print "ERROR: COULD NOT EXECUTE: STDOUT:"
        print node.out
        if node.error<>"":
            print "ERROR: COULD NOT EXECUTE: ERROR:"
            print node.error
        print "ERROR: could not execute:%s on \n%s"%(cmd,node)
        j.admin.setNode(node)
        if args.sync:
            j.application.stop(1)
    
    gridname,name=hostkey.split("__")
    node=j.admin.getNode(gridname,name)
    sr=node.getScriptRun()
    if cmd<>"":        
        error=False
        r=RedirectSTDOUT(hostkey)
        print "execute:%s:%s:"%(hostkey,cmd),
        if args.sync==False:            
            sys.stdout=r
        try:
            node.executeCmds(cmd)
        except BaseException,e:
            sys.stdout=r.oldstdout            
            print "ERROR"
            error=True
            report(node,args)
        sys.stdout=r.oldstdout
        if sr.state<>"OK":
            print "ERROR"
            report(node,args)
        elif not error:
            print "OK"   
    else:
        for cmd in args.name.split(","):  #name is name of jumpscript
            cmd=cmd.lower().strip()
            key="%s_%s"%(hostkey,cmd.strip())
            r=RedirectSTDOUT(key)            
            print "execute:%s:%s:"%(hostkey,cmd),
            if args.sync==False:                
                sys.stdout=r

            once=True
            if j.admin.args.force:
                once=False

            j.admin. executeForNode(node,jsname=cmd,once=once)
            sys.stdout=r.oldstdout
            if sr.state<>"OK":
                print "ERROR"
                report(node,args)
            else:
                print "OK"
    j.admin.setNode(node)
    from IPython import embed
    print "DEBUG NOW uuu"
    embed()
    

import JumpScale.baselib.admin


if __name__ == '__main__':
    # hosts=["cpu10","cpu12"]

    admin=j.tools.admin.get(args)
    j.admin=admin

    for hostkey in j.admin.hostKeys:

        if not args.sync:
            p = Process(target=doRemote, args=(args,hostkey,args.command,))
            p.start()
        else:
            doRemote(args,hostkey,args.command)

    from IPython import embed
    print "DEBUG NOW execute done"
    embed()
    

    for hostkey in j.admin.hostKeys:
        obj = queue.get()
        # print obj
        if obj[3].strip()<>"":
            print "##ERROR##%-10s %-20s##\n%s\n%s\n###############################################"%obj
        else:
            print "##%-10s %-20s##\n%s\n%s"%obj

    exitcode = 1 if admin.errors else 0

    j.application.stop(exitcode)


